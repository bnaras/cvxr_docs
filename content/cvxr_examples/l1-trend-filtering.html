---
title: L1 Trend Filtering
author: Anqi Fu and Balasubramanian Narasimhan
date: '2017-11-02'
slug: cvxr_l1-trend-filtering
bibliography: ../bibtex/cvxr_refs.bib
link-citations: true
categories: []
tags: []
params:
  mode: ignore
  check_dir: test_data
  data_dir: l1-trend-filtering
---



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p><span class="citation">Kim et al. (<a href="#ref-Kim:et_al:2009">2009</a>)</span> propose the <span class="math inline">\(l_1\)</span> trend filtering method for trend
estimation. The method solves an optimization problem of the form</p>
<p><span class="math display">\[
\begin{array}{ll}
\underset{\beta}{\mbox{minimize}} &amp; \frac{1}{2}\sum_{i=1}^m (y_i - \beta_i)^2 + \lambda ||D\beta||_1
\end{array}
\]</span>
where the variable to be estimated is <span class="math inline">\(\beta\)</span> and we are given the
problem data <span class="math inline">\(y\)</span> and <span class="math inline">\(\lambda\)</span>. The matrix <span class="math inline">\(D\)</span> is the second-order
difference matrix,</p>
<p><span class="math display">\[
D = 
\left[
\begin{matrix} 1 &amp;  -2  &amp;  1      &amp;        &amp;        &amp;    &amp;   \\ 
                 &amp;   1  &amp; -2      &amp;  1     &amp;        &amp;    &amp;   \\
                 &amp;      &amp;  \ddots &amp; \ddots &amp; \ddots &amp;    &amp;   \\
                 &amp;      &amp;         &amp; 1      &amp; -2     &amp;  1 &amp;   \\
                 &amp;      &amp;         &amp;        &amp; 1      &amp; -2 &amp;  1\\              
\end{matrix}
\right].
\]</span></p>
<p>The implementation is in both C and Matlab. Hadley Wickham provides an
R interface to the C code. This is
on <a href="https://github.com/hadley/l1tf">GitHub</a> and can be installed via:</p>
<pre class="r"><code>library(devtools)
install_github(&quot;hadley/l1tf&quot;)</code></pre>
</div>
<div id="example" class="section level2">
<h2>Example</h2>
<p>We will use the example in <code>l1tf</code> to illustrate. The package provides
the function <code>l1tf</code> which computes the trend estimate for a specified
<span class="math inline">\(\lambda\)</span>.</p>
<pre class="r"><code>sp_data &lt;- data.frame(x = sp500$date,
                      y = sp500$log,
                      l1_50 = l1tf(sp500$log, lambda = 50),
                      l1_100 = l1tf(sp500$log, lambda = 100))</code></pre>
</div>
<div id="the-cvxr-version" class="section level2">
<h2>The <code>CVXR</code> version</h2>
<p><code>CVXR</code> provides all the atoms and functions necessary to formulat the
problem in a few lines. For example, the <span class="math inline">\(D\)</span> matrix above is provided
by the function <code>diff(..., differences = 2)</code>. Notice how the
formulation tracks the mathematical construct above.</p>
<pre class="r"><code>## lambda = 50
y &lt;- sp500$log
lambda_1 &lt;- 50 
beta &lt;- Variable(length(y))
objective_1 &lt;- Minimize(0.5 * p_norm(y - beta) +
                        lambda_1 * p_norm(diff(x = beta, differences = 2), 1))
p1 &lt;- Problem(objective_1)
betaHat_50 &lt;- solve(p1)$getValue(beta)</code></pre>
<pre><code>## Acquiring MOSEK environment
## Problem
##   Name                   :                 
##   Objective sense        : min             
##   Type                   : CONIC (conic optimization problem)
##   Constraints            : 6000            
##   Cones                  : 1               
##   Scalar variables       : 6003            
##   Matrix variables       : 0               
##   Integer variables      : 0               
## 
## Optimizer started.
## Presolve started.
## Linear dependency checker started.
## Linear dependency checker terminated.
## Eliminator started.
## Freed constraints in eliminator : 1999
## Eliminator terminated.
## Eliminator started.
## Freed constraints in eliminator : 0
## Eliminator terminated.
## Eliminator - tries                  : 2                 time                   : 0.00            
## Lin. dep.  - tries                  : 1                 time                   : 0.00            
## Lin. dep.  - number                 : 0               
## Presolve terminated. Time: 0.01    
## Problem
##   Name                   :                 
##   Objective sense        : min             
##   Type                   : CONIC (conic optimization problem)
##   Constraints            : 6000            
##   Cones                  : 1               
##   Scalar variables       : 6003            
##   Matrix variables       : 0               
##   Integer variables      : 0               
## 
## Optimizer  - threads                : 8               
## Optimizer  - solved problem         : the primal      
## Optimizer  - Constraints            : 1999
## Optimizer  - Cones                  : 1
## Optimizer  - Scalar variables       : 6000              conic                  : 2002            
## Optimizer  - Semi-definite variables: 0                 scalarized             : 0               
## Factor     - setup time             : 0.01              dense det. time        : 0.00            
## Factor     - ML order time          : 0.00              GP order time          : 0.00            
## Factor     - nonzeros before factor : 7993              after factor           : 7994            
## Factor     - dense dim.             : 2                 flops                  : 6.40e+04        
## ITE PFEAS    DFEAS    GFEAS    PRSTATUS   POBJ              DOBJ              MU       TIME  
## 0   1.0e+00  4.0e+02  1.5e+00  0.00e+00   5.000000000e-01   0.000000000e+00   1.0e+00  0.02  
## 1   6.9e-05  2.7e-02  1.4e-03  -9.90e-01  -1.953068719e+02  1.924456317e-02   6.8e-05  0.02  
## 2   6.3e-07  2.5e-04  1.3e-06  9.74e-01   -1.795079957e+00  2.608553365e-02   6.2e-07  0.03  
## 3   1.1e-07  4.2e-05  7.9e-08  1.00e+00   3.179473244e-01   5.665789881e-01   1.1e-07  0.03  
## 4   3.9e-08  1.5e-05  1.7e-08  1.00e+00   6.970646830e-01   7.825482611e-01   3.8e-08  0.03  
## 5   1.4e-08  5.4e-06  2.9e-09  1.00e+00   8.526354584e-01   8.733339893e-01   1.4e-08  0.03  
## 6   7.6e-09  3.0e-06  1.1e-09  1.00e+00   9.390189740e-01   9.491745423e-01   7.6e-09  0.03  
## 7   5.0e-09  2.0e-06  5.7e-10  1.00e+00   9.669583197e-01   9.727955104e-01   5.0e-09  0.04  
## 8   2.2e-09  8.8e-07  1.5e-10  1.00e+00   1.014745249e+00   1.016762311e+00   2.2e-09  0.04  
## 9   8.5e-10  3.4e-07  2.9e-11  1.00e+00   1.030758822e+00   1.031297086e+00   8.4e-10  0.04  
## 10  3.2e-10  1.2e-07  5.8e-12  1.00e+00   1.038656561e+00   1.038809920e+00   3.1e-10  0.04  
## 11  1.0e-10  4.1e-08  9.3e-13  1.00e+00   1.040421829e+00   1.040458272e+00   1.0e-10  0.04  
## 12  5.5e-11  2.2e-08  3.3e-13  1.00e+00   1.040809148e+00   1.040825471e+00   5.5e-11  0.05  
## 13  1.5e-11  6.0e-09  4.4e-14  1.00e+00   1.041092815e+00   1.041096608e+00   1.5e-11  0.05  
## 14  4.1e-12  1.6e-09  5.0e-15  1.00e+00   1.041133407e+00   1.041134075e+00   4.1e-12  0.05  
## 15  1.6e-12  6.3e-10  1.1e-15  1.00e+00   1.041141983e+00   1.041142187e+00   1.6e-12  0.05  
## 16  9.5e-14  3.8e-11  1.4e-17  1.00e+00   1.041144907e+00   1.041144917e+00   9.4e-14  0.05  
## Optimizer terminated. Time: 0.06    
## 
## 
## Interior-point solution summary
##   Problem status  : PRIMAL_AND_DUAL_FEASIBLE
##   Solution status : OPTIMAL
##   Primal.  obj: 1.0411449069e+00    nrm: 7e+00    Viol.  con: 8e-11    var: 0e+00    cones: 0e+00  
##   Dual.    obj: 1.0411449170e+00    nrm: 5e+01    Viol.  con: 9e-10    var: 9e-10    cones: 0e+00  
## Optimizer summary
##   Optimizer                 -                        time: 0.06    
##     Interior-point          - iterations : 16        time: 0.06    
##       Basis identification  -                        time: 0.00    
##         Primal              - iterations : 0         time: 0.00    
##         Dual                - iterations : 0         time: 0.00    
##         Clean primal        - iterations : 0         time: 0.00    
##         Clean dual          - iterations : 0         time: 0.00    
##     Simplex                 -                        time: 0.00    
##       Primal simplex        - iterations : 0         time: 0.00    
##       Dual simplex          - iterations : 0         time: 0.00    
##     Mixed integer           - relaxations: 0         time: 0.00</code></pre>
<pre class="r"><code>## lambda = 100
lambda_2 &lt;- 100
objective_2 &lt;- Minimize(0.5 * p_norm(y - beta) +
                        lambda_2 * p_norm(diff(x = beta, differences = 2), 1))
p2 &lt;- Problem(objective_2)
betaHat_100 &lt;- solve(p2)$getValue(beta)</code></pre>
<pre><code>## Problem
##   Name                   :                 
##   Objective sense        : min             
##   Type                   : CONIC (conic optimization problem)
##   Constraints            : 6000            
##   Cones                  : 1               
##   Scalar variables       : 6003            
##   Matrix variables       : 0               
##   Integer variables      : 0               
## 
## Optimizer started.
## Presolve started.
## Linear dependency checker started.
## Linear dependency checker terminated.
## Eliminator started.
## Freed constraints in eliminator : 1999
## Eliminator terminated.
## Eliminator started.
## Freed constraints in eliminator : 0
## Eliminator terminated.
## Eliminator - tries                  : 2                 time                   : 0.00            
## Lin. dep.  - tries                  : 1                 time                   : 0.00            
## Lin. dep.  - number                 : 0               
## Presolve terminated. Time: 0.01    
## Problem
##   Name                   :                 
##   Objective sense        : min             
##   Type                   : CONIC (conic optimization problem)
##   Constraints            : 6000            
##   Cones                  : 1               
##   Scalar variables       : 6003            
##   Matrix variables       : 0               
##   Integer variables      : 0               
## 
## Optimizer  - threads                : 8               
## Optimizer  - solved problem         : the primal      
## Optimizer  - Constraints            : 1999
## Optimizer  - Cones                  : 1
## Optimizer  - Scalar variables       : 6000              conic                  : 2002            
## Optimizer  - Semi-definite variables: 0                 scalarized             : 0               
## Factor     - setup time             : 0.00              dense det. time        : 0.00            
## Factor     - ML order time          : 0.00              GP order time          : 0.00            
## Factor     - nonzeros before factor : 7993              after factor           : 7994            
## Factor     - dense dim.             : 2                 flops                  : 6.40e+04        
## ITE PFEAS    DFEAS    GFEAS    PRSTATUS   POBJ              DOBJ              MU       TIME  
## 0   1.0e+00  8.0e+02  1.5e+00  0.00e+00   5.000000000e-01   0.000000000e+00   1.0e+00  0.01  
## 1   3.5e-05  2.7e-02  1.0e-03  -9.95e-01  -3.926080214e+02  1.923821907e-02   3.4e-05  0.02  
## 2   1.6e-07  1.3e-04  3.3e-07  9.74e-01   -1.895502678e+00  2.357866585e-02   1.6e-07  0.02  
## 3   2.5e-08  2.0e-05  1.7e-08  1.00e+00   4.509574674e-01   6.732293600e-01   2.5e-08  0.02  
## 4   8.1e-09  6.4e-06  3.1e-09  1.00e+00   8.484608329e-01   9.167328005e-01   8.0e-09  0.02  
## 5   4.3e-09  3.4e-06  1.1e-09  1.00e+00   9.855675820e-01   1.014988584e+00   4.2e-09  0.02  
## 6   2.2e-09  1.8e-06  3.8e-10  1.00e+00   1.095400038e+00   1.108521239e+00   2.2e-09  0.02  
## 7   1.1e-09  8.3e-07  1.1e-10  1.00e+00   1.152362391e+00   1.157113357e+00   1.0e-09  0.03  
## 8   4.4e-10  3.5e-07  2.6e-11  1.00e+00   1.195913931e+00   1.197522718e+00   4.4e-10  0.03  
## 9   2.2e-10  1.7e-07  7.8e-12  1.00e+00   1.205984277e+00   1.206593888e+00   2.1e-10  0.03  
## 10  1.1e-10  8.6e-08  2.5e-12  1.00e+00   1.212681483e+00   1.212933437e+00   1.1e-10  0.03  
## 11  2.2e-11  1.8e-08  1.5e-13  1.00e+00   1.215160133e+00   1.215180392e+00   2.2e-11  0.03  
## 12  9.4e-12  7.4e-09  3.6e-14  1.00e+00   1.215689218e+00   1.215695982e+00   9.3e-12  0.03  
## 13  2.3e-12  1.9e-09  3.7e-15  1.00e+00   1.215828517e+00   1.215829663e+00   2.3e-12  0.04  
## 14  1.2e-12  9.4e-10  1.2e-15  1.00e+00   1.215839582e+00   1.215840094e+00   1.2e-12  0.04  
## 15  2.7e-13  2.1e-10  1.3e-16  1.00e+00   1.215849560e+00   1.215849669e+00   2.6e-13  0.04  
## 16  7.9e-14  6.2e-11  2.1e-17  1.00e+00   1.215851544e+00   1.215851576e+00   7.8e-14  0.04  
## 17  2.3e-14  1.8e-11  2.7e-18  1.00e+00   1.215852074e+00   1.215852081e+00   2.2e-14  0.04  
## Optimizer terminated. Time: 0.05    
## 
## 
## Interior-point solution summary
##   Problem status  : PRIMAL_AND_DUAL_FEASIBLE
##   Solution status : OPTIMAL
##   Primal.  obj: 1.2158520741e+00    nrm: 7e+00    Viol.  con: 4e-11    var: 0e+00    cones: 0e+00  
##   Dual.    obj: 1.2158520807e+00    nrm: 1e+02    Viol.  con: 9e-10    var: 9e-10    cones: 0e+00  
## Optimizer summary
##   Optimizer                 -                        time: 0.05    
##     Interior-point          - iterations : 17        time: 0.05    
##       Basis identification  -                        time: 0.00    
##         Primal              - iterations : 0         time: 0.00    
##         Dual                - iterations : 0         time: 0.00    
##         Clean primal        - iterations : 0         time: 0.00    
##         Clean dual          - iterations : 0         time: 0.00    
##     Simplex                 -                        time: 0.00    
##       Primal simplex        - iterations : 0         time: 0.00    
##       Dual simplex          - iterations : 0         time: 0.00    
##     Mixed integer           - relaxations: 0         time: 0.00</code></pre>
<p><em>NOTE</em> Of course, <code>CVXR</code> is much slower since it is not optimized just
for one problem.</p>
</div>
<div id="comparison-plots" class="section level2">
<h2>Comparison Plots</h2>
<p>A plot of the estimates for two values of <span class="math inline">\(\lambda\)</span> is shown below
using both approaches. First the <code>l1tf</code> plot.</p>
<pre class="r"><code>ggplot(data = sp_data) +
    geom_line(mapping = aes(x = x, y = y), color = &#39;grey50&#39;) +
    labs(x = &quot;Date&quot;, y = &quot;SP500 log-price&quot;) +
    geom_line(mapping = aes(x = x, y = l1_50), color = &#39;red&#39;, size = 1) +
    geom_line(mapping = aes(x = x, y = l1_100), color = &#39;blue&#39;, size = 1)</code></pre>
<div class="figure"><span id="fig:unnamed-chunk-6"></span>
<img src="/cvxr_examples/l1-trend-filtering_files/figure-html/unnamed-chunk-6-1.png" alt="$L_1$ trends for $\lambda = 50$ (red) and $\lambda = 100$ (blue)." width="672" />
<p class="caption">
Figure 1: <span class="math inline">\(L_1\)</span> trends for <span class="math inline">\(\lambda = 50\)</span> (red) and <span class="math inline">\(\lambda = 100\)</span> (blue).
</p>
</div>
<p>Next the corresponding <code>CVXR</code> plots.</p>
<pre class="r"><code>cvxr_data &lt;- data.frame(x = sp500$date,
                        y = sp500$log,
                        l1_50 = betaHat_50,
                        l1_100 = betaHat_100)
ggplot(data = cvxr_data) +
    geom_line(mapping = aes(x = x, y = y), color = &#39;grey50&#39;) +
    labs(x = &quot;Date&quot;, y = &quot;SP500 log-price&quot;) +
    geom_line(mapping = aes(x = x, y = l1_50), color = &#39;red&#39;, size = 1) +
    geom_line(mapping = aes(x = x, y = l1_100), color = &#39;blue&#39;, size = 1)</code></pre>
<div class="figure"><span id="fig:unnamed-chunk-7"></span>
<img src="/cvxr_examples/l1-trend-filtering_files/figure-html/unnamed-chunk-7-1.png" alt="`CVXR` estimated $L_1$ trends for $\lambda = 50$ (red) and $\lambda = 100$ (blue)." width="672" />
<p class="caption">
Figure 2: <code>CVXR</code> estimated <span class="math inline">\(L_1\)</span> trends for <span class="math inline">\(\lambda = 50\)</span> (red) and <span class="math inline">\(\lambda = 100\)</span> (blue).
</p>
</div>
</div>
<div id="notes" class="section level2">
<h2>Notes</h2>
<p>The <code>CVXR</code> solution is not quite exactly that of <code>l1tf</code>: on the left it shows a larger difference for the two
<span class="math inline">\(\lambda\)</span> values; in the middle, it is less flatter than <code>l1tf</code>; and
on the right, it does not have as many knots as <code>l1tf</code>.</p>
</div>
<div id="session-info" class="section level2">
<h2>Session Info</h2>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 3.6.1 (2019-07-05)
## Platform: x86_64-apple-darwin19.0.0 (64-bit)
## Running under: macOS Catalina 10.15.1
## 
## Matrix products: default
## BLAS/LAPACK: /usr/local/Cellar/openblas/0.3.7/lib/libopenblasp-r0.3.7.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices datasets  utils     methods   base     
## 
## other attached packages:
## [1] l1tf_0.0.0.9000 ggplot2_3.2.1   CVXR_0.995     
## 
## loaded via a namespace (and not attached):
##  [1] gmp_0.5-13.5      Rcpp_1.0.3        highr_0.8         compiler_3.6.1   
##  [5] pillar_1.4.2      R.methodsS3_1.7.1 R.utils_2.9.0     tools_3.6.1      
##  [9] digest_0.6.23     bit_1.1-14        evaluate_0.14     lifecycle_0.1.0  
## [13] tibble_2.1.3      gtable_0.3.0      lattice_0.20-38   pkgconfig_2.0.3  
## [17] rlang_0.4.2       Matrix_1.2-17     gurobi_9.0-0      Rglpk_0.6-4      
## [21] yaml_2.2.0        blogdown_0.17     xfun_0.11         withr_2.1.2      
## [25] dplyr_0.8.3       Rmpfr_0.7-2       stringr_1.4.0     knitr_1.26       
## [29] tidyselect_0.2.5  bit64_0.9-7       grid_3.6.1        glue_1.3.1       
## [33] R6_2.4.1          rmarkdown_1.17    bookdown_0.16     farver_2.0.1     
## [37] purrr_0.3.3       magrittr_1.5      scales_1.1.0      htmltools_0.4.0  
## [41] assertthat_0.2.1  colorspace_1.4-1  labeling_0.3      Rcplex_0.3-3     
## [45] stringi_1.4.3     Rmosek_9.1.0      lazyeval_0.2.2    munsell_0.5.0    
## [49] slam_0.1-46       crayon_1.3.4      R.oo_1.23.0</code></pre>
</div>
<div id="source" class="section level2">
<h2>Source</h2>
<p><a href="https://github.com/bnaras/cvxr_docs/blob/master/content/cvxr_examples/l1-trend-filtering.Rmd">R Markdown</a></p>
</div>
<div id="references" class="section level2 unnumbered">
<h2>References</h2>
<div id="refs" class="references">
<div id="ref-Kim:et_al:2009">
<p>Kim, Seung-Jean, Kwangmoo Koh, Stephen Boyd, and Dimitry Gorinevsky. 2009. “<span class="math inline">\(l_1\)</span> Trend Filtering.” <em>SIAM Review</em> 51 (2): 339–60. <a href="https://doi.org/doi:10.1137/070690274" class="uri">https://doi.org/doi:10.1137/070690274</a>.</p>
</div>
</div>
</div>
